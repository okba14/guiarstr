name: Build & Test guiarstr Library

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and Test on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config lcov

      # ----- BUILD USING MAKEFILE -----
      - name: üß± Build static and shared libraries (Makefile)
        run: |
          echo "Building with Makefile..."
          make

      # ----- RUN TESTS WITH COVERAGE -----
      - name: üß™ Run tests with coverage
        run: |
          echo "Running tests with coverage..."
          make clean || true
          make CFLAGS="--coverage" LDFLAGS="--coverage"
          make test || echo "No make test target found."
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --list coverage.info

      # ----- UPLOAD TO CODECOV -----
      - name: üì§ Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.info
          fail_ci_if_error: true

      # ----- BUILD EXAMPLE -----
      - name: üí° Build example program
        run: |
          echo "Building example..."
          make example || echo "No example target found."

      # ----- INSTALL LOCALLY -----
      - name: üì¶ Install library locally
        run: |
          echo "Installing to $HOME/.local ..."
          make install PREFIX=$HOME/.local

      # ----- VERIFY PKG-CONFIG -----
      - name: üîç Verify pkg-config
        run: |
          export PKG_CONFIG_PATH=$HOME/.local/lib/pkgconfig
          pkg-config --cflags --libs guiarstr
          echo "pkg-config verified successfully."

      # ----- OPTIONAL: CMAKE BUILD -----
      - name: üß© Build using CMake
        run: |
          echo "Building with CMake..."
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)
          sudo make install
        continue-on-error: true  

      # ----- TEST COMPILE AN EXAMPLE USING PKG-CONFIG -----
      - name: üß™ Test compile example with pkg-config
        run: |
          export PKG_CONFIG_PATH=$HOME/.local/lib/pkgconfig
          gcc examples/usage.c $(pkg-config --cflags --libs guiarstr) -o demo
          ./demo || echo "Demo ran without errors."
