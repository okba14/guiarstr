name: Build & Test guiarstr Library

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    name: Build and Test on Ubuntu
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§° Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config

      # ----- BUILD USING MAKEFILE -----
      - name: ğŸ§± Build static and shared libraries (Makefile)
        run: |
          echo "Building with Makefile..."
          make

      - name: ğŸ§ª Run test suite
        run: |
          echo "Running tests..."
          make test || echo "No make test target found."

      - name: ğŸ’¡ Build example program
        run: |
          echo "Building example..."
          make example || echo "No example target found."

      # ----- INSTALL LOCALLY -----
      - name: ğŸ“¦ Install library locally
        run: |
          echo "Installing to $HOME/.local ..."
          make install PREFIX=$HOME/.local

      # Verify pkg-config installation
      - name: ğŸ” Verify pkg-config
        run: |
          export PKG_CONFIG_PATH=$HOME/.local/lib/pkgconfig
          pkg-config --cflags --libs guiarstr
          echo "pkg-config verified successfully."

      # ----- OPTIONAL: CMAKE BUILD -----
      - name: ğŸ§© Build using CMake
        run: |
          echo "Building with CMake..."
          mkdir -p build && cd build
          cmake ..
          make -j$(nproc)
          sudo make install
        continue-on-error: true  # Ù„Ø§ ÙŠØªÙˆÙ‚Ù Ø¥Ù† ÙØ´Ù„Øª Ø®Ø·ÙˆØ© CMake

      # ----- TEST COMPILE AN EXAMPLE USING PKG-CONFIG -----
      - name: ğŸ§ª Test compile example with pkg-config
        run: |
          export PKG_CONFIG_PATH=$HOME/.local/lib/pkgconfig
          gcc examples/usage.c $(pkg-config --cflags --libs guiarstr) -o demo
          ./demo || echo "Demo ran without errors."
